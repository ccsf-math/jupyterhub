#!/bin/bash -l
set -euo pipefail

jupyter server extension enable --sys-prefix nbgitpuller
playwright install chromium

mkdir -p /srv/conda/envs/notebook/share/jupyter/lab/settings
cp -u overrides.json /srv/conda/envs/notebook/share/jupyter/lab/settings

# Define the configuration file path
CONFIG_FILE="$(jupyter --config-dir)/jupyter_nbconvert_config.py"

# Create the configuration file if it doesn't exist
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Configuration file not found. Creating $CONFIG_FILE..."
    jupyter nbconvert --generate-config
fi

# Check if the embed_images setting is already present
if grep -q "c\.HTMLExporter\.embed_images" "$CONFIG_FILE"; then
    echo "Setting 'c.HTMLExporter.embed_images' found. Modifying it to True..."
    sed -i "s/^c\.HTMLExporter\.embed_images\s*=.*/c.HTMLExporter.embed_images = True/" "$CONFIG_FILE"
else
    echo "Setting 'c.HTMLExporter.embed_images' not found. Adding it to the configuration..."
    echo "c.HTMLExporter.embed_images = True" >> "$CONFIG_FILE"
fi

echo "Configuration updated successfully."
